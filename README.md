# Телеграм бот для получения информации по серийному номеру

Бот для получения информации о продукте по его серийному номеру. Информация хранится в таблице Google Sheet.

## Установка

1. Установите зависимости:
```bash
pip install -r requirements.txt
```

2. Настройте доступ к Google Sheets (см. раздел [Настройка Google Sheets API](#настройка-google-sheets-api))

3. Создайте файл `.env` и укажите необходимые переменные окружения:
```
BOT_TOKEN=your_bot_token_here
SHEET_ID=your_sheet_id_here
SHEET_NAME=Sheet1
SHEET_PAT=path/to/service-account-key.json
SERIAL_NUMBER_COLUMN=1
IGNORE_COLUMNS=
```

## Настройка Google Sheets API

Для работы бота необходимо настроить доступ к Google Sheets API. Следуйте инструкции ниже.

### 1. Создание проекта в Google Cloud Console

1. Перейдите в [Google Cloud Console](https://console.cloud.google.com/)
2. Нажмите на кнопку выбора проекта в верхней панели
3. Нажмите "Создать проект"
4. Введите название проекта (например, "Telegram Bot Sheets")
5. Нажмите "Создать" и дождитесь создания проекта
6. Убедитесь, что созданный проект выбран в верхней панели

### 2. Включение Google Sheets API

1. В меню слева выберите **"Библиотека"** (или "APIs & Services" > "Library")
2. В строке поиска введите **"Google Sheets API"**
3. Выберите "Google Sheets API" из результатов
4. Нажмите кнопку **"Включить"** (Enable)
5. Дождитесь активации API

### 3. Создание Service Account (сервисного аккаунта)

1. В меню слева выберите **"Учетные данные"** (или "APIs & Services" > "Credentials")
2. Нажмите **"Создать учетные данные"** (Create Credentials)
3. Выберите **"Сервисный аккаунт"** (Service Account)
4. Введите название сервисного аккаунта (например, "telegram-bot-service")
5. Нажмите **"Создать и продолжить"** (Create and Continue)
6. На этапе "Предоставить этому сервисному аккаунту доступ к проекту" можете пропустить (нажать "Продолжить")
7. Нажмите **"Готово"** (Done)

### 4. Создание и скачивание JSON ключа

1. В списке сервисных аккаунтов найдите созданный аккаунт
2. Нажмите на email сервисного аккаунта
3. Перейдите на вкладку **"Ключи"** (Keys)
4. Нажмите **"Добавить ключ"** (Add Key) > **"Создать новый ключ"** (Create new key)
5. Выберите формат **JSON**
6. Нажмите **"Создать"** (Create)
7. JSON файл автоматически скачается на ваш компьютер
8. **Важно:** Сохраните этот файл в безопасном месте! Он содержит конфиденциальные данные для доступа к Google Sheets

### 5. Получение ID таблицы (SHEET_ID)

1. Откройте вашу Google Таблицу в браузере
2. Посмотрите на URL в адресной строке. Он будет выглядеть так:
   ```
   https://docs.google.com/spreadsheets/d/1aBcD_efGhIjKlMnOpQrStUvWxYz/edit#gid=0
   ```
3. ID таблицы находится между `/d/` и `/edit`
4. В примере выше ID таблицы: `1aBcD_efGhIjKlMnOpQrStUvWxYz`
5. Скопируйте этот ID — он понадобится для переменной `SHEET_ID`

### 6. Получение названия листа (SHEET_NAME)

1. В открытой Google Таблице посмотрите на вкладки внизу
2. Название листа — это название вкладки (по умолчанию "Sheet1")
3. Если вы переименовали лист, используйте новое название
4. Это значение для переменной `SHEET_NAME`

### 7. Предоставление доступа к таблице

**Важно:** Без этого шага бот не сможет читать данные из таблицы!

1. Откройте вашу Google Таблицу
2. Нажмите кнопку **"Настройки доступа"** (Share) в правом верхнем углу
3. В поле "Добавить пользователей и группы" введите **email сервисного аккаунта**
   - Email можно найти в скачанном JSON файле в поле `client_email`
   - Или в Google Cloud Console в разделе "Сервисные аккаунты"
4. Выберите права доступа: **"Редактор"** (Editor) или **"Читатель"** (Viewer) — для чтения данных достаточно "Читатель"
5. Снимите галочку "Уведомить пользователей" (если не хотите отправлять уведомление)
6. Нажмите **"Отправить"** (Send)

### 8. Настройка переменных окружения

Создайте файл `.env` в корне проекта со следующими переменными:

```env
# Токен Telegram бота (получите у @BotFather)
BOT_TOKEN=your_bot_token_here

# ID Google Таблицы (из URL, см. шаг 5)
SHEET_ID=1aBcD_efGhIjKlMnOpQrStUvWxYz

# Название листа в таблице (по умолчанию "Sheet1")
SHEET_NAME=Sheet1

# Путь к JSON файлу сервисного аккаунта (см. шаг 4)
# Вариант 1: Путь к файлу
SHEET_PAT=/path/to/service-account-key.json

# Вариант 2: Или можно использовать переменную GOOGLE_APPLICATION_CREDENTIALS
# GOOGLE_APPLICATION_CREDENTIALS=/path/to/service-account-key.json

# Номер столбца с серийными номерами (1 = первый столбец, 2 = второй и т.д.)
SERIAL_NUMBER_COLUMN=1

# Номера столбцов, которые нужно игнорировать при выводе (через запятую)
# Например: IGNORE_COLUMNS=2,5,7
IGNORE_COLUMNS=
```

**Примечания:**
- `SHEET_PAT` может быть либо путем к JSON файлу, либо самим JSON содержимым (если нужно хранить в переменной окружения)
- Если используете Docker, убедитесь, что JSON файл доступен в контейнере (скопируйте его или используйте volume)

### Структура таблицы

Таблица должна иметь следующую структуру:
- **Первая строка** — заголовки столбцов (будут использованы для форматирования вывода)
- **Первый столбец** (или указанный в `SERIAL_NUMBER_COLUMN`) — серийные номера
- **Остальные столбцы** — данные, которые будут выводиться пользователю

Пример таблицы:

| Серийный номер | Дата производства | Производитель | Модель | Комментарий |
| ------------- | ---------------- | ------------ | ----- | ----------- |
| 012345678912 | 2026-01-01 | Вася Иванов | Сатурн | Хороший |
| 012345678913 | 2026-01-01 | Петя Петров | Юпитер | Плохой |

### Дополнительные ресурсы

- [Официальная документация Google Sheets API](https://developers.google.com/sheets/api)
- [Документация библиотеки gspread](https://docs.gspread.org/)
- [Статья на Хабре: Google Sheets API + Python](https://habr.com/ru/articles/575160/)

## Запуск

### Локальный запуск

```bash
python bot.py
```

### Запуск в Docker

#### Использование Docker Compose (рекомендуется)

1. Убедитесь, что файл `.env` создан и содержит токен бота
2. Запустите контейнер:
```bash
docker-compose up -d
```

3. Просмотр логов:
```bash
docker-compose logs -f
```

4. Остановка контейнера:
```bash
docker-compose down
```

#### Использование Docker напрямую

1. Соберите образ:
```bash
docker build -t telegram-chillskill-info-bot .
```

2. Запустите контейнер:
```bash
docker run -d --name telegram-chillskill-info-bot --env-file .env --restart unless-stopped telegram-chillskill-info-bot
```

3. Просмотр логов:
```bash
docker logs -f telegram-chillskill-info-bot
```

4. Остановка контейнера:
```bash
docker stop telegram-chillskill-info-bot
docker rm telegram-chillskill-info-bot
```

## Команды бота

- `/start` — выводит информацию о боте и инструкцию по использованию

## Использование

После запуска бота отправьте ему серийный номер (любым текстовым сообщением). Бот:

1. Проверит формат серийного номера (должен содержать 12 цифр и иметь валидную контрольную сумму по алгоритму Луна)
2. Нормализует серийный номер (удалит пробелы, дефисы и другие символы)
3. Найдет данные в Google Таблице
4. Выведет информацию в формате:
   ```
   ✅ Серийный номер: XXXX-XXXX-XXXX
   
   Заголовок столбца 1: Значение 1
   Заголовок столбца 2: Значение 2
   ...
   ```

### Примеры использования

**Пример 1: Валидный серийный номер**
```
Пользователь: 012345678912
Бот: ✅ Серийный номер: 0123-4567-8912

Дата производства: 2026-01-01
Производитель: Вася Иванов
Модель: Сатурн
Комментарий: Хороший
```

**Пример 2: Серийный номер с форматированием**
```
Пользователь: 0123-4567-8912
Бот: ✅ Серийный номер: 0123-4567-8912

Дата производства: 2026-01-01
Производитель: Вася Иванов
Модель: Сатурн
Комментарий: Хороший
```

**Пример 3: Невалидный серийный номер**
```
Пользователь: 12345
Бот: ❌ Серийный номер должен содержать ровно 12 цифр
```

**Пример 4: Серийный номер не найден**
```
Пользователь: 999999999999
Бот: ❌ Серийный номер 9999-9999-9999 не найден в базе данных.
```

## Переменные окружения

| Переменная | Описание | Обязательная | По умолчанию |
| --------- | -------- | ------------ | ------------ |
| `BOT_TOKEN` | Токен Telegram бота от @BotFather | Да | - |
| `SHEET_ID` | ID Google Таблицы | Да | - |
| `SHEET_NAME` | Название листа в таблице | Нет | `Sheet1` |
| `SHEET_PAT` | Путь к JSON файлу service account или сам JSON | Да* | - |
| `GOOGLE_APPLICATION_CREDENTIALS` | Альтернативный способ указания пути к credentials | Нет** | - |
| `SERIAL_NUMBER_COLUMN` | Номер столбца с серийными номерами (1-based) | Нет | `1` |
| `IGNORE_COLUMNS` | Номера столбцов для игнорирования (через запятую) | Нет | - |

\* Необходимо указать либо `SHEET_PAT`, либо `GOOGLE_APPLICATION_CREDENTIALS`  
\** Используется только если не указан `SHEET_PAT`

## Разработка

### Запуск тестов

```bash
pytest test_get_info_sn.py
```

### Структура проекта

```
.
├── bot.py                 # Основной файл бота
├── serial_number.py       # Модуль для работы с серийными номерами
├── luhn_algorithm.py      # Алгоритм Луна для проверки контрольной суммы
├── google_sheets.py       # Модуль для работы с Google Sheets
├── test_get_info_sn.py    # Тесты
├── requirements.txt       # Зависимости
├── Dockerfile            # Docker образ
├── docker-compose.yml     # Docker Compose конфигурация
└── README.md             # Документация
```
